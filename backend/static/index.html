<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Predict Aggregator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f7f8fa; color: #1a1a1a; }

    /* Header */
    .header {
      background: #fff; border-bottom: 1px solid #e5e5e5;
      padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
    }
    .logo { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
    .logo span { color: #6366f1; }

    /* Container */
    .container { max-width: 820px; margin: 40px auto; padding: 0 20px; }

    /* Grid 2x2 */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 1fr;
      gap: 20px;
    }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

    /* Card */
    .card {
      background: #fff; border-radius: 16px; padding: 24px;
      border: 1px solid #e8e8e8; display: flex; flex-direction: column;
      transition: box-shadow .2s, transform .2s; cursor: pointer;
    }
    .card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.07); transform: translateY(-2px); }
    .card:active { transform: translateY(0); }

    /* Card top */
    .card-top { display: flex; align-items: flex-start; gap: 14px; margin-bottom: 20px; }
    .card-icon {
      width: 44px; height: 44px; border-radius: 12px; background: #f0f0f5;
      display: flex; align-items: center; justify-content: center; font-size: 22px;
      flex-shrink: 0;
    }
    .card-title { font-size: 16px; font-weight: 700; line-height: 1.35; color: #111; }

    /* Outcomes */
    .outcomes { flex: 1; display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }

    .outcome-row {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 12px; border-radius: 10px; background: #fafafa;
    }
    .outcome-name {
      font-size: 14px; color: #333; flex: 1;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .outcome-pct { font-size: 15px; font-weight: 700; color: #111; min-width: 40px; text-align: right; }

    .outcome-btns { display: flex; gap: 6px; }
    .btn-yes, .btn-no {
      padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 600;
      border: none; cursor: pointer; min-width: 44px; min-height: 44px;
      display: flex; align-items: center; justify-content: center;
      transition: background .15s;
    }
    .btn-yes { background: #dcfce7; color: #16a34a; }
    .btn-yes:hover { background: #bbf7d0; }
    .btn-no { background: #fee2e2; color: #dc2626; }
    .btn-no:hover { background: #fecaca; }

    /* Footer */
    .card-footer {
      margin-top: auto; padding-top: 14px; border-top: 1px solid #f0f0f0;
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-stats { font-size: 12px; color: #999; }
    .platform-icons { display: flex; gap: 5px; }
    .platform-icon {
      width: 22px; height: 22px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; color: #fff;
      overflow: hidden; flex-shrink: 0;
    }
    .platform-icon img {
      width: 100%; height: 100%; object-fit: cover;
    }

    /* Loading state */
    .loading {
      text-align: center; padding: 60px 20px;
      color: #999; font-size: 15px;
    }

    /* Error state */
    .error {
      text-align: center; padding: 40px 20px;
      color: #dc2626; font-size: 14px;
      background: #fef2f2; border-radius: 12px;
    }
    .error-retry {
      margin-top: 12px; padding: 10px 24px; border-radius: 8px;
      border: 1px solid #dc2626; background: #fff; color: #dc2626;
      font-size: 13px; font-weight: 600; cursor: pointer;
    }

    .connect-btn {
      padding: 10px 20px; border-radius: 10px; border: none;
      background: #6366f1; color: #fff; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: background .15s;
    }
    .connect-btn:hover { background: #4f46e5; }
    .connect-btn.connected { background: #16a34a; }
    .connect-btn.connected:hover { background: #15803d; }
  </style>
</head>
<body>

<div class="header">
  <div class="logo"><span>Predict</span> Aggregator</div>
  <div class="wallet-wrap" id="walletWrap">
    <button class="connect-btn" id="walletBtn" onclick="toggleWalletDropdown()">Connect Wallet</button>
  </div>
</div>

<div class="container">
  <div id="grid" class="grid">
    <div class="loading" style="grid-column: 1/-1;">Loading events...</div>
  </div>
</div>

<script>
const PLATFORMS = {
  polymarket: { name: 'Polymarket', logo: '/public/polymarket.jpg' },
  opinion:    { name: 'Opinion',    logo: '/public/opinion.jpg' },
  limitless:  { name: 'Limitless',  logo: '/public/limitless.svg' },
};

async function render() {
  const grid = document.getElementById('grid');
  try {
    const resp = await fetch('/static/events.json');
    if (!resp.ok) throw new Error('Failed to load events');
    const events = await resp.json();

    if (!events.length) {
      grid.innerHTML = '<div class="loading" style="grid-column:1/-1;">No events available</div>';
      return;
    }

    grid.innerHTML = events.map(ev => `
      <div class="card" onclick="location.href='/market?id=${ev.id}'">
        <div class="card-top">
          <div class="card-icon">${ev.icon}</div>
          <div class="card-title">${ev.title}</div>
        </div>
        <div class="outcomes">
          ${ev.outcomes.slice(0, 2).map(o => `
            <div class="outcome-row">
              <span class="outcome-name">${o.name}</span>
              <span class="outcome-pct">${o.pct}%</span>
              <div class="outcome-btns">
                <button class="btn-yes">Yes</button>
                <button class="btn-no">No</button>
              </div>
            </div>
          `).join('')}
        </div>
        <div class="card-footer">
          <span class="card-stats">${ev.volume} &bull; ${ev.txs}</span>
          <div class="platform-icons">
            ${ev.platforms.map(p => {
              const pl = PLATFORMS[p];
              return `<div class="platform-icon" title="${pl.name}"><img src="${pl.logo}" alt="${pl.name}"></div>`;
            }).join('')}
          </div>
        </div>
      </div>
    `).join('');
  } catch (e) {
    grid.innerHTML = `
      <div class="error" style="grid-column:1/-1;">
        <div>Could not load events: ${e.message}</div>
        <button class="error-retry" onclick="render()">Retry</button>
      </div>`;
  }
}

render();

// Wallet connection
let walletAddress = null;

function shortAddr(addr) {
  return addr.slice(0, 6) + '...' + addr.slice(-4);
}

function updateWalletBtn() {
  const btn = document.getElementById('walletBtn');
  if (walletAddress) {
    btn.textContent = shortAddr(walletAddress);
    btn.classList.add('connected');
  } else {
    btn.textContent = 'Connect Wallet';
    btn.classList.remove('connected');
  }
}

async function connectWallet() {
  if (walletAddress) return;
  if (!window.ethereum) {
    alert('No wallet found. Install MetaMask or another wallet.');
    return;
  }
  try {
    await window.ethereum.request({ method: 'wallet_requestPermissions', params: [{ eth_accounts: {} }] });
    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
    walletAddress = accounts[0];
    localStorage.setItem('walletAddress', walletAddress);
    updateWalletBtn();
  } catch (e) {
    console.error('Wallet connect failed:', e);
  }
}

// Restore session
(function restoreWallet() {
  const saved = localStorage.getItem('walletAddress');
  if (saved) {
    walletAddress = saved;
    updateWalletBtn();
  }
  // Listen for account changes
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', (accounts) => {
      walletAddress = accounts[0] || null;
      if (walletAddress) localStorage.setItem('walletAddress', walletAddress);
      else localStorage.removeItem('walletAddress');
      updateWalletBtn();
    });
  }
})();
</script>
<script src="/static/wallet-dropdown.js"></script>
</body>
</html>
